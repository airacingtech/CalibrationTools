<?xml version="1.0" encoding="UTF-8"?>
<launch>
  <arg name="vehicle_id" default="default"/>
  <let name="sensor_model" value="aip_xx1"/>
  <arg name="camera_name" default=""/>
  <arg name="rviz" default="false"/>

  <!-- we do not use the standard image_raw name to avoid naming conflicts -->
  <let name="lidar_model" value="velodyne_vls128"/>
  <let name="calibration_sensor_frame" value="velodyne_top"/>
  <let name="rviz_profile" value="$(find-pkg-share extrinsic_tag_based_base_calibrator)/rviz/velodyne_top.rviz"/>

  <let name="image_decompressed_topic" value="/sensing/camera/camera0/image_rect_color/decompressed"/>
  <let name="image_compressed_topic" value="/sensing/camera/camera0/image_rect_color/compressed"/>
  <let name="camera_info_topic" value="/sensing/camera/camera0/camera_info"/>
  <let name="pointcloud_topic" value="/sensing/lidar/top/pointcloud_raw"/>

  <let name="camera_frame" value="camera0/camera_link"/>

  <!-- calibration api -->
  <arg name="base_frame" default="base_link"/>
  <arg name="sensor_kit_frame" default="sensor_kit_base_link"/>
  <arg name="lidar_base_frame" default="velodyne_top_base_link"/>
  <arg name="lidar_frame" default="velodyne_top"/>

  <!-- image decompressor -->
  <node pkg="image_transport_decompressor" exec="image_transport_decompressor_node" name="decompressor" output="screen">
    <remap from="decompressor/input/compressed_image" to="$(var image_compressed_topic)"/>
    <remap from="decompressor/output/raw_image" to="$(var image_decompressed_topic)"/>
  </node>

  <!-- lidartag detector -->
  <include file="$(find-pkg-share lidartag)/launch/lidartag_$(var lidar_model).launch.xml">
    <arg name="pointcloud_topic" value="$(var pointcloud_topic)"/>
  </include>

  <node pkg="tier4_tag_utils" exec="lidartag_filter_node" name="lidartag_filter" output="screen">
    <param name="max_no_observation_time" value="3.0"/>
    <param name="new_hypothesis_distance" value="1.5"/>

    <param name="new_hypothesis_transl" value="0.1"/>
    <param name="new_hypothesis_rot" value="15.0"/>
    <param name="measurement_noise_transl" value="0.05"/>
    <param name="measurement_noise_rot" value="5.0"/>
    <param name="process_noise_transl" value="0.01"/>
    <param name="process_noise_transl_dot" value="0.001"/>
    <param name="process_noise_rot" value="1.0"/>
    <param name="process_noise_rot_dot" value="0.1"/>
  </node>

  <!-- apriltag detector -->
  <include file="$(find-pkg-share extrinsic_tag_based_calibrator)/launch/apriltag_16h5.launch.py">
    <arg name="image_topic" value="$(var image_decompressed_topic)"/>
    <arg name="camera_info_topic" value="$(var camera_info_topic)"/>
  </include>

  <node pkg="tier4_tag_utils" exec="apriltag_filter_node" name="apriltag_filter" output="screen">
    <!-- filtering parameters -->
    <param name="min_tag_size" value="0.6"/>
    <!--0.6 = 0.8 * 0.75 the apriltag size, not the lidartag-->
    <param name="max_tag_distance" value="30.0"/>
    <param name="max_allowed_homography_error" value="0.5"/>
    <param name="min_margin" value="50.0"/>
    <param name="max_hamming_error" value="0"/>

    <param name="max_no_observation_time" value="3.0"/>
    <param name="new_hypothesis_distance" value="1.5"/>
    <param name="tag_ids" value="[0, 3, 4]"/>
    <param name="tag_sizes" value="[0.6, 0.6, 0.6]"/>
    <!-- the sizes of tag_ids -->
    <param name="max_convergence_transl" value="2.0"/>
    <param name="new_hypothesis_transl" value="20.0"/>

    <param name="measurement_noise_transl" value="0.2"/>
    <param name="process_noise_transl" value="0.02"/>
  </node>

  <!-- base -> sensor_kit: extrinsic_calibration_client -->
  <arg name="base_to_sensor_kit_src_yaml" default="$(find-pkg-share individual_params)/config/$(var vehicle_id)/$(var sensor_model)/sensors_calibration.yaml"/>
  <arg name="base_to_sensor_kit_dst_yaml" default="$(env HOME)/sensors_calibration.yaml"/>

  <node pkg="extrinsic_calibration_client" exec="extrinsic_calibration_client" name="base_to_sensor_kit_extrinsic_calibration_client" output="screen">
    <remap from="extrinsic_calibration_manager" to="base_to_sensor_kit_extrinsic_calibration_manager"/>
    <param name="src_path" value="$(var base_to_sensor_kit_src_yaml)"/>
    <param name="dst_path" value="$(var base_to_sensor_kit_dst_yaml)"/>
  </node>

  <!-- base -> sensor_kit: extrinsic_calibration_manager -->
  <node pkg="extrinsic_calibration_manager" exec="extrinsic_calibration_manager" name="base_to_sensor_kit_extrinsic_calibration_manager" output="screen">
    <remap from="extrinsic_calibration_manager" to="base_to_sensor_kit_extrinsic_calibration_manager"/>
    <param name="parent_frame" value="base_link"/>
    <param name="child_frames" value="
    [sensor_kit_base_link]"/>
  </node>

  <!-- sensor_kit -> lidar_base: extrinsic_calibration_client -->
  <arg name="sensor_kit_to_lidar_base_src_yaml" default="$(find-pkg-share individual_params)/config/$(var vehicle_id)/$(var sensor_model)/sensor_kit_calibration.yaml"/>
  <arg name="sensor_kit_to_lidar_base_dst_yaml" default="$(env HOME)/sensor_kit_calibration.yaml"/>

  <node pkg="extrinsic_calibration_client" exec="extrinsic_calibration_client" name="sensor_kit_to_lidar_extrinsic_calibration_client" output="screen">
    <remap from="extrinsic_calibration_manager" to="sensor_kit_to_lidar_extrinsic_calibration_manager"/>
    <param name="src_path" value="$(var sensor_kit_to_lidar_base_src_yaml)"/>
    <param name="dst_path" value="$(var sensor_kit_to_lidar_base_dst_yaml)"/>
  </node>

  <!-- sensor_kit -> lidar_base: extrinsic_calibration_manager -->
  <node pkg="extrinsic_calibration_manager" exec="extrinsic_calibration_manager" name="sensor_kit_to_lidar_extrinsic_calibration_manager" output="screen">
    <remap from="extrinsic_calibration_manager" to="sensor_kit_to_lidar_extrinsic_calibration_manager"/>
    <param name="parent_frame" value="sensor_kit_base_link"/>
    <param name="child_frames" value="
    [velodyne_top_base_link]"/>
  </node>

  <!-- base-lidar calibrator -->
  <include file="$(find-pkg-share extrinsic_tag_based_base_calibrator)/launch/calibrator.launch.xml">
    <!-- calibration api parameters -->
    <arg name="base_frame" value="$(var base_frame)"/>
    <arg name="sensor_kit_frame" value="$(var sensor_kit_frame)"/>
    <arg name="lidar_base_frame" value="$(var lidar_base_frame)"/>
    <arg name="lidar_frame" value="$(var lidar_frame)"/>

    <arg name="base_link_to_sensor_kit_calibration_service" value="base_link/sensor_kit_base_link/extrinsic_calibration"/>
    <arg name="sensor_kit_to_lidar_calibration_service" value="sensor_kit_base_link/velodyne_top_base_link/extrinsic_calibration"/>

    <!-- calibration parameters-->
    <arg name="calibration_sensor_frame" value="$(var calibration_sensor_frame)"/>
    <arg name="calibration_sensor_type" value="lidar"/>
    <arg name="apriltag_detections_topic" value="/apriltag/filtered/detection_array"/>
    <arg name="lidartag_detections_topic" value="/lidartag/filtered/detections_array"/>
  </include>

  <!-- calibration parameters-->
  <node pkg="tf2_ros" exec="static_transform_publisher" name="estimated_base_link_broadcaster" output="screen" args="0 0 0 0 0 0 velodyne_top estimated_base_link"/>

  <node pkg="rviz2" exec="rviz2" name="rviz2" output="log" args="-d $(var rviz_profile)" if="$(var rviz)"/>
</launch>
